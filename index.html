<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>帽帽健身配對平台</title>
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    body {
      background: #f5f5f5;
      color: #333;
      min-height: 100vh;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #4a90e2;
      color: #fff;
    }
    header h1 {
      font-size: 1.5rem;
    }
    header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    main {
      padding: 1rem;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
      padding: 1rem;
    }
    button {
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      margin-right: 0.5rem;
    }
    button:disabled {
      background: #888;
    }
    .form-list li {
      list-style: none;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      background: #f0f7ff;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .form-list li button {
      margin-left: 0.5rem;
    }
    .hidden {
      display: none;
    }
    .select-container {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .select-container label {
      flex: 0 0 120px;
    }
    .select-container select {
      flex: 1;
      padding: 0.25rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    table th,
    table td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: left;
    }
    table th {
      background: #f0f0f0;
    }
    .result-section {
      margin-bottom: 1rem;
    }
    .countdown {
      font-weight: bold;
      margin-left: 0.5rem;
      color: #e67e22;
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="page-login">
    <main style="text-align:center; padding-top:30vh;">
      <h1 style="font-size:2.5rem; margin-bottom:1.5rem;">帽帽</h1>
      <button onclick="onLogin()" style="padding:0.75rem 2rem; font-size:1rem;">登入</button>
    </main>
  </div>

  <!-- Dashboard Page -->
  <div id="page-dashboard" class="hidden">
    <header>
      <h1>帽帽</h1>
      <img src="https://placekitten.com/80/80" alt="使用者頭像" />
    </header>
    <main>
      <!-- 公告區 -->
      <div class="card">
        <h2>公告</h2>
        <p>歡迎使用帽帽健身偏好配對平台！請先建立自己的訓練表單，再使用配對碼與朋友進行匹配。</p>
      </div>
      <!-- 表單區 -->
      <div class="card">
        <h2>我的表單</h2>
        <ul id="formList" class="form-list"></ul>
        <!-- 建立新表單按鈕，加上 id 方便控制顯示 -->
        <button id="newFormBtn" onclick="createNewForm()">建立新表單</button>
      </div>
      <!-- 配對功能區 -->
      <div class="card">
        <h2>配對功能</h2>
        <div id="pairSection">
          <!-- 下拉選擇配對用的表單，動態填入 -->
          <select id="pairFormSelect" style="margin-right:0.5rem; padding:0.25rem;"></select>
          <button id="generateCodeBtn" onclick="generatePairCode()">建立配對碼</button>
          <span id="generatedCode" style="font-weight:bold; margin-left:0.5rem;"></span>
          <span id="countdown" class="countdown"></span>
        </div>
        <div style="margin-top:1rem;">
          <input type="text" id="pairInput" placeholder="輸入配對碼" style="padding:0.25rem; width:70%;" />
          <button onclick="enterPairCode()">配對</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Form Creation / Edit Page -->
  <div id="page-form" class="hidden">
    <header>
      <h1>編輯表單</h1>
      <button onclick="goBackToDashboard()" style="background:#fff; color:#4a90e2; border:1px solid #4a90e2;">返回</button>
    </header>
    <main>
      <div class="card">
        <label>表單名稱：
          <input type="text" id="formName" placeholder="輸入表單名稱" style="width:100%; padding:0.25rem; margin-top:0.25rem;" />
        </label>
      </div>
      <div id="formArea"></div>
      <button onclick="saveCurrentForm()" style="margin-top:1rem;">儲存表單</button>
    </main>
  </div>

  <!-- Form Preview Page -->
  <div id="page-preview" class="hidden">
    <header>
      <h1>表單預覽</h1>
      <button onclick="goBackToDashboard()" style="background:#fff; color:#4a90e2; border:1px solid #4a90e2;">返回</button>
    </header>
    <main id="previewContent"></main>
  </div>

  <!-- Pair Result Page -->
  <div id="page-result" class="hidden">
    <header>
      <h1>配對結果</h1>
      <button onclick="goBackToDashboard()" style="background:#fff; color:#4a90e2; border:1px solid #4a90e2;">返回</button>
    </header>
    <main>
      <div class="card">
        <h2>配對雙方</h2>
        <div style="display:flex; align-items:center;">
          <div style="flex:1; text-align:center;">
            <img src="https://placekitten.com/80/80" alt="A" style="border-radius:50%;" />
            <p>使用者A</p>
          </div>
          <div style="flex:1; text-align:center;">
            <img src="https://placekitten.com/81/81" alt="B" style="border-radius:50%;" />
            <p>使用者B</p>
          </div>
        </div>
      </div>
      <div id="resultContent"></div>
    </main>
  </div>

  <script>
    // Service worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }

    // Exercise data structure
    const exerciseData = [
      {
        area: '背部訓練',
        subareas: [
          { name: '上背', actions: ['引體向上', '高位下拉', '面拉'] },
          { name: '下背', actions: ['硬舉', '背屈伸'] }
        ]
      },
      {
        area: '腿部訓練',
        subareas: [
          { name: '股四頭肌', actions: ['腿舉', '腿伸展'] },
          { name: '腿後肌群', actions: ['腿彎舉', '硬舉'] }
        ]
      }
    ];

    // State variables
    let forms = {}; // {id: {name, data}}
    let currentFormId = null;
    let pairCodes = {}; // {code: {formId, expires}}
    let countdownTimer = null;

    // Load from localStorage on start
    function loadFromStorage() {
      const formData = localStorage.getItem('forms');
      if (formData) {
        try {
          forms = JSON.parse(formData);
        } catch (e) {
          forms = {};
        }
      }
      const codeData = localStorage.getItem('pairCodes');
      if (codeData) {
        try {
          pairCodes = JSON.parse(codeData);
        } catch (e) {
          pairCodes = {};
        }
      }
    }

    function saveToStorage() {
      localStorage.setItem('forms', JSON.stringify(forms));
      localStorage.setItem('pairCodes', JSON.stringify(pairCodes));
    }

    // Page navigation
    function showPage(pageId) {
      const pages = ['page-login','page-dashboard','page-form','page-preview','page-result'];
      pages.forEach(pid => {
        document.getElementById(pid).classList.toggle('hidden', pid !== pageId);
      });
    }

    function onLogin() {
      showPage('page-dashboard');
      updateDashboard();
    }

    function goBackToDashboard() {
      showPage('page-dashboard');
      updateDashboard();
    }

    // Dashboard update
    function updateDashboard() {
      loadFromStorage();
      const formList = document.getElementById('formList');
      formList.innerHTML = '';
      const keys = Object.keys(forms);
      // Update new form button visibility
      const newFormBtn = document.getElementById('newFormBtn');
      // Update pair form select options
      const select = document.getElementById('pairFormSelect');
      select.innerHTML = '';
      // Clear generated code and countdown when switching
      document.getElementById('generatedCode').textContent = '';
      document.getElementById('countdown').textContent = '';
      clearInterval(countdownTimer);
      if (keys.length === 0) {
        // Hide new form button because we show a big bar instead
        if (newFormBtn) newFormBtn.style.display = 'none';
        // Show long bar prompting to create new form
        const li = document.createElement('li');
        li.style.width = '100%';
        // Create a styled div acting as a long bar
        const bar = document.createElement('div');
        bar.textContent = '點擊新建表單';
        bar.style.padding = '1rem';
        bar.style.border = '2px dashed #4a90e2';
        bar.style.background = '#e7f3ff';
        bar.style.textAlign = 'center';
        bar.style.cursor = 'pointer';
        bar.onclick = createNewForm;
        li.appendChild(bar);
        formList.appendChild(li);
        // Populate select with a single option
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '尚未有表單';
        select.appendChild(opt);
        // Disable generate code button
        document.getElementById('generateCodeBtn').disabled = true;
      } else {
        // Show new form button
        if (newFormBtn) newFormBtn.style.display = 'inline-block';
        // Populate form list
        keys.forEach(id => {
          const li = document.createElement('li');
          li.textContent = forms[id].name;
          const editBtn = document.createElement('button');
          editBtn.textContent = '編輯';
          editBtn.onclick = () => editForm(id);
          const previewBtn = document.createElement('button');
          previewBtn.textContent = '預覽';
          previewBtn.onclick = () => previewForm(id);
          li.appendChild(editBtn);
          li.appendChild(previewBtn);
          // Add a red delete button after the preview button
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '刪除';
          deleteBtn.style.background = '#e74c3c';
          deleteBtn.style.color = '#fff';
          deleteBtn.style.border = 'none';
          deleteBtn.style.marginLeft = '0.5rem';
          deleteBtn.onclick = () => deleteForm(id);
          li.appendChild(deleteBtn);
          formList.appendChild(li);
        });
        // Populate select options
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = '請選擇表單';
        select.appendChild(defaultOpt);
        keys.forEach(id => {
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = forms[id].name;
          select.appendChild(opt);
        });
        // Enable generate code button
        document.getElementById('generateCodeBtn').disabled = false;
      }
    }

    // Create new form
    function createNewForm() {
      currentFormId = null;
      document.getElementById('formName').value = '';
      buildFormArea({});
      showPage('page-form');
    }

    // Edit existing form
    function editForm(id) {
      currentFormId = id;
      const f = forms[id];
      document.getElementById('formName').value = f.name;
      buildFormArea(f.data);
      showPage('page-form');
    }

    // Build dynamic form UI
    function buildFormArea(savedData) {
      const container = document.getElementById('formArea');
      container.innerHTML = '';
      exerciseData.forEach(area => {
        const areaDiv = document.createElement('div');
        areaDiv.className = 'card';
        const areaTitle = document.createElement('h3');
        areaTitle.textContent = area.area;
        areaDiv.appendChild(areaTitle);
        area.subareas.forEach(sub => {
          const subTitle = document.createElement('h4');
          subTitle.textContent = sub.name;
          areaDiv.appendChild(subTitle);
          sub.actions.forEach(act => {
            const row = document.createElement('div');
            row.className = 'select-container';
            const label = document.createElement('label');
            label.textContent = act;
            row.appendChild(label);
            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = (savedData && savedData[act] && savedData[act].experienced) ? '✅' : '❌';
            toggleBtn.style.marginRight = '0.5rem';
            toggleBtn.onclick = () => {
              const val = toggleBtn.textContent === '✅';
              toggleBtn.textContent = val ? '❌' : '✅';
            };
            row.appendChild(toggleBtn);
            const sel = document.createElement('select');
            const options = ['Unknown', 'No', '0', '1', '2', '3', '5', '6'];
            options.forEach(opt => {
              const o = document.createElement('option');
              o.value = opt;
              o.textContent = opt;
              sel.appendChild(o);
            });
            // Set default value
            if (savedData && savedData[act]) {
              sel.value = savedData[act].value;
            }
            row.appendChild(sel);
            row.dataset.action = act;
            areaDiv.appendChild(row);
          });
        });
        container.appendChild(areaDiv);
      });
    }

    // Save form
    function saveCurrentForm() {
      const name = document.getElementById('formName').value.trim();
      if (!name) {
        alert('請輸入表單名稱');
        return;
      }
      // Gather data
      const inputs = document.querySelectorAll('#formArea .select-container');
      const data = {};
      inputs.forEach(row => {
        const act = row.dataset.action;
        const experienced = row.querySelector('button').textContent === '✅';
        const value = row.querySelector('select').value;
        data[act] = { experienced, value };
      });
      if (currentFormId) {
        forms[currentFormId] = { name, data };
      } else {
        const id = 'form-' + Date.now();
        forms[id] = { name, data };
        currentFormId = id;
      }
      saveToStorage();
      alert('表單已儲存！');
      showPage('page-dashboard');
      updateDashboard();
    }

    // Preview form
    function previewForm(id) {
      currentFormId = id;
      const f = forms[id];
      const preview = document.getElementById('previewContent');
      preview.innerHTML = '';
      const title = document.createElement('h2');
      title.textContent = f.name;
      preview.appendChild(title);
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>動作</th><th>有經驗</th><th>意願值</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      Object.keys(f.data).forEach(act => {
        const tr = document.createElement('tr');
        const tdAct = document.createElement('td');
        tdAct.textContent = act;
        const tdExp = document.createElement('td');
        tdExp.textContent = f.data[act].experienced ? '✅' : '❌';
        const tdVal = document.createElement('td');
        tdVal.textContent = f.data[act].value;
        tr.appendChild(tdAct);
        tr.appendChild(tdExp);
        tr.appendChild(tdVal);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      preview.appendChild(table);
      showPage('page-preview');
    }

    // Delete a form by its ID. Shows a confirmation prompt before deletion
    function deleteForm(id) {
      if (confirm('確定要刪除此表單嗎？此操作無法復原。')) {
        // Delete the entry from the forms object
        delete forms[id];
        // Reset current selection if necessary
        if (currentFormId === id) {
          currentFormId = null;
        }
        // Persist changes and update UI
        saveToStorage();
        updateDashboard();
        showPage('page-dashboard');
      }
    }

    // Delete a form by its ID with user confirmation
    function deleteForm(id) {
      // Ask for confirmation before deleting
      if (confirm('確定要刪除此表單嗎？此操作無法復原。')) {
        // Remove the form data
        delete forms[id];
        // Reset currentFormId if the deleted form was selected
        if (currentFormId === id) {
          currentFormId = null;
        }
        // Persist changes
        saveToStorage();
        // Update UI and navigate back to the dashboard
        updateDashboard();
        showPage('page-dashboard');
      }
    }

    // Generate random 6-digit code
    function generatePairCode() {
      loadFromStorage();
      const select = document.getElementById('pairFormSelect');
      const selectedId = select ? select.value : '';
      const keys = Object.keys(forms);
      if (!selectedId) {
        if (keys.length === 0) {
          alert('請新建表單');
        } else {
          alert('請先選擇要配對的表單');
        }
        return;
      }
      currentFormId = selectedId;
      const code = ('' + Math.floor(100000 + Math.random() * 900000));
      const expires = Date.now() + 5 * 60 * 1000; // 5 mins
      pairCodes[code] = { formId: currentFormId, expires };
      saveToStorage();
      document.getElementById('generatedCode').textContent = code;
      startCountdown(code, expires);
      alert('配對碼已建立：' + code + '\n請在五分鐘內與對方分享此配對碼。');
    }

    // Start countdown for pair code
    function startCountdown(code, expires) {
      clearInterval(countdownTimer);
      const countdownElem = document.getElementById('countdown');
      function update() {
        const now = Date.now();
        const diff = expires - now;
        if (diff <= 0) {
          clearInterval(countdownTimer);
          countdownElem.textContent = '配對碼已過期';
          delete pairCodes[code];
          saveToStorage();
          return;
        }
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        countdownElem.textContent = `剩餘 ${minutes}分${seconds}秒`;
      }
      update();
      countdownTimer = setInterval(update, 1000);
    }

    // Enter pair code
    function enterPairCode() {
      const input = document.getElementById('pairInput').value.trim();
      if (!input) {
        alert('請輸入配對碼');
        return;
      }
      loadFromStorage();
      const info = pairCodes[input];
      if (!info) {
        alert('配對碼不存在或已被使用');
        return;
      }
      const now = Date.now();
      if (now > info.expires) {
        delete pairCodes[input];
        saveToStorage();
        alert('配對碼已過期');
        return;
      }
      // For demonstration, pair the stored form with itself or with first available form
      const form1 = forms[info.formId];
      let form2 = null;
      // If there is another form, use it; else use the same
      const keysArr = Object.keys(forms);
      if (keysArr.length > 1) {
        for (let k of keysArr) {
          if (k !== info.formId) {
            form2 = forms[k];
            break;
          }
        }
      }
      if (!form2) form2 = form1;
      // Compute results
      const results = computePairResults(form1.data, form2.data);
      delete pairCodes[input];
      saveToStorage();
      displayResults(results);
      showPage('page-result');
    }

    // Compute pair results based on rules
    function computePairResults(data1, data2) {
      const avoid = [];
      const favorite = [];
      const discuss = [];
      const normal = [];
      const allActions = Object.keys(data1);
      allActions.forEach(act => {
        const val1 = data1[act].value;
        const val2 = data2[act].value;
        if (val1 === 'No' && val2 === 'No') {
          avoid.push(act);
        } else if (val1 === '6' && val2 === '6') {
          favorite.push(act);
        } else if ((val1 === '6' && val2 === 'Unknown') || (val2 === '6' && val1 === 'Unknown')) {
          discuss.push(act);
        } else {
          normal.push(act);
        }
      });
      return { avoid, favorite, discuss, normal };
    }

    // Display results on result page
    function displayResults(res) {
      const container = document.getElementById('resultContent');
      container.innerHTML = '';
      const sections = [
        { title: '雙方都拒絕的項目 (避免)', list: res.avoid },
        { title: '雙方都喜愛的項目 (最愛)', list: res.favorite },
        { title: '一人最愛、一人未知 (可討論)', list: res.discuss },
        { title: '其他項目 (普通)', list: res.normal }
      ];
      sections.forEach(sec => {
        if (sec.list.length > 0) {
          const div = document.createElement('div');
          div.className = 'result-section card';
          const h3 = document.createElement('h3');
          h3.textContent = sec.title;
          div.appendChild(h3);
          const ul = document.createElement('ul');
          ul.style.listStyle = 'disc inside';
          sec.list.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            ul.appendChild(li);
          });
          div.appendChild(ul);
          container.appendChild(div);
        }
      });
    }

    // Initialize on load
    window.addEventListener('load', () => {
      loadFromStorage();
    });
  </script>
</body>
</html>
